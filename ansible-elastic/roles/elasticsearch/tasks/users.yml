---
# ===================== Wait for Elasticsearch =====================
- name: Wait for Elasticsearch API (authenticated)
  uri:
    url: "http://localhost:{{ elasticsearch_http_port }}"
    method: GET
    user: elastic
    password: "{{ elasticsearch_bootstrap_password }}"
    force_basic_auth: true
    status_code: 200
  register: es_up
  retries: 12
  delay: 5
  until: es_up.status == 200

# ===================== Check application user =====================
- name: Check if application user exists
  uri:
    url: "http://localhost:{{ elasticsearch_http_port }}/_security/user/{{ elasticsearch_app_user }}"
    method: GET
    user: elastic
    password: "{{ elasticsearch_bootstrap_password }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: app_user_check
  changed_when: false

# ===================== Create application user =====================
- name: Create application user as superuser
  uri:
    url: "http://localhost:{{ elasticsearch_http_port }}/_security/user/{{ elasticsearch_app_user }}"
    method: PUT
    user: elastic
    password: "{{ elasticsearch_bootstrap_password }}"
    force_basic_auth: true
    body_format: json
    body:
      password: "{{ elasticsearch_app_password }}"
      roles:
        - superuser
    status_code: [200, 201]
  when: app_user_check.status == 404
